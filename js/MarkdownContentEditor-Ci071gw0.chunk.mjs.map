{"version":3,"file":"MarkdownContentEditor-Ci071gw0.chunk.mjs","sources":["../src/components/Editor/MarkdownContentEditor.vue"],"sourcesContent":["<!--\n  - SPDX-FileCopyrightText: 2022 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<Wrapper\n\t\t:content-loaded=\"true\"\n\t\t:show-outline-outside=\"showOutlineOutside\"\n\t\t@outline-toggled=\"outlineToggled\">\n\t\t<MainContainer>\n\t\t\t<template v-if=\"showMenuBar\">\n\t\t\t\t<MenuBar v-if=\"!readOnly\" :autohide=\"false\" />\n\t\t\t\t<slot v-else name=\"readonlyBar\">\n\t\t\t\t\t<ReadonlyBar />\n\t\t\t\t</slot>\n\t\t\t</template>\n\t\t\t<ContentContainer :read-only=\"readOnly\" />\n\t\t</MainContainer>\n\t</Wrapper>\n</template>\n\n<script>\nimport { Editor } from '@tiptap/core'\nimport MenuBar from '../Menu/MenuBar.vue'\nimport MainContainer from './MainContainer.vue'\nimport Wrapper from './Wrapper.vue'\n/* eslint-disable import/no-named-as-default */\nimport { getCurrentUser } from '@nextcloud/auth'\nimport { UndoRedo } from '@tiptap/extensions'\nimport { provide, watch } from 'vue'\nimport { provideEditor } from '../../composables/useEditor.ts'\nimport { editorFlagsKey } from '../../composables/useEditorFlags.ts'\nimport { useEditorMethods } from '../../composables/useEditorMethods.ts'\nimport { FocusTrap, RichText } from '../../extensions/index.js'\nimport { createMarkdownSerializer } from '../../extensions/Markdown.js'\nimport AttachmentResolver from '../../services/AttachmentResolver.js'\nimport { ATTACHMENT_RESOLVER } from '../Editor.provider.ts'\nimport ReadonlyBar from '../Menu/ReadonlyBar.vue'\nimport ContentContainer from './ContentContainer.vue'\n\nexport default {\n\tname: 'MarkdownContentEditor',\n\tcomponents: { ContentContainer, ReadonlyBar, MenuBar, MainContainer, Wrapper },\n\tprovide() {\n\t\tconst val = {}\n\n\t\tObject.defineProperties(val, {\n\t\t\t[ATTACHMENT_RESOLVER]: {\n\t\t\t\tget: () => this.$attachmentResolver ?? null,\n\t\t\t},\n\t\t})\n\n\t\treturn val\n\t},\n\n\tprops: {\n\t\tfileId: {\n\t\t\ttype: Number,\n\t\t\tdefault: null,\n\t\t},\n\t\tcontent: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\treadOnly: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t\trelativePath: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t\tshareToken: {\n\t\t\ttype: String,\n\t\t\tdefault: null,\n\t\t},\n\t\tshowMenuBar: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true,\n\t\t},\n\t\tshowOutlineOutside: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t},\n\temits: ['update:content'],\n\n\tsetup(props) {\n\t\tconst extensions = [\n\t\t\tRichText.configure({\n\t\t\t\textensions: [UndoRedo],\n\t\t\t}),\n\t\t\tFocusTrap,\n\t\t]\n\t\tconst editor = new Editor({ extensions })\n\n\t\tconst { setEditable, setContent } = useEditorMethods(editor)\n\t\twatch(\n\t\t\t() => props.content,\n\t\t\t(content) => {\n\t\t\t\tsetContent(content)\n\t\t\t},\n\t\t)\n\n\t\tsetEditable(!props.readOnly)\n\t\twatch(\n\t\t\t() => props.readOnly,\n\t\t\t(readOnly) => {\n\t\t\t\tsetEditable(!readOnly)\n\t\t\t},\n\t\t)\n\n\t\tprovideEditor(editor)\n\t\tprovide(editorFlagsKey, {\n\t\t\tisPublic: false,\n\t\t\tisRichEditor: true,\n\t\t\tisRichWorkspace: false,\n\t\t})\n\t\treturn { editor, setContent }\n\t},\n\n\tcreated() {\n\t\t// Set content after the setup function\n\t\t// as it may render other vue components such as preview toggle\n\t\t// which breaks the context of the setup function.\n\t\tthis.setContent(this.content, { addToHistory: false })\n\t\tthis.editor.on('create', () => {\n\t\t\tthis.$emit('ready')\n\t\t\tthis.$parent.$emit('ready')\n\t\t})\n\t\tthis.editor.on('update', ({ editor }) => {\n\t\t\tconst markdown = createMarkdownSerializer(editor.schema).serialize(\n\t\t\t\teditor.state.doc,\n\t\t\t)\n\t\t\tthis.emit('update:content', {\n\t\t\t\tjson: editor.state.doc,\n\t\t\t\tmarkdown,\n\t\t\t})\n\t\t})\n\t\tif (this.fileId) {\n\t\t\tthis.$attachmentResolver = new AttachmentResolver({\n\t\t\t\tcurrentDirectory: this.relativePath?.match(/.*\\//),\n\t\t\t\tuser: getCurrentUser(),\n\t\t\t\tshareToken: this.shareToken,\n\t\t\t\tfileId: this.fileId,\n\t\t\t})\n\t\t}\n\t},\n\n\tbeforeDestroy() {\n\t\tthis.editor.destroy()\n\t},\n\n\tmethods: {\n\t\toutlineToggled(visible) {\n\t\t\tthis.emit('outline-toggled', visible)\n\t\t},\n\n\t\t/**\n\t\t * Wrapper to emit events on our own and the parent component\n\t\t *\n\t\t * The parent might be either the root component of src/editor.js or Viewer.vue which collectives currently uses\n\t\t *\n\t\t * Ideally this would be done in a generic way in the src/editor.js API abstraction, but it seems\n\t\t * that there is no proper way to pass any received event along in vue, the only option I've found\n\t\t * in https://github.com/vuejs/vue/issues/230 feels too hacky to me, so we just emit twice for now\n\t\t *\n\t\t * @param {string} event The event name\n\t\t * @param {any} data The data to pass along\n\t\t */\n\t\temit(event, data) {\n\t\t\tthis.$emit(event, data)\n\t\t\tthis.$parent?.$emit(event, data)\n\t\t},\n\t},\n}\n</script>\n\n<style lang=\"scss\">\n@use './../../css/prosemirror';\n@use './../../css/print';\n</style>\n"],"names":[],"mappings":"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"}