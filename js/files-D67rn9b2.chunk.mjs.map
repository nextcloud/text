{"version":3,"mappings":"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","names":["TextSvg","FILE_ACTION_IDENTIFIER","registerFileActionFallback","sharingToken","getSharingToken","filesTable","ViewerRoot","registerAction","mime","imagePath","filename","file","__vitePreload","n","imports","path","Vue","Editor","h","self","i","openMimetypes","newWorkspaceCreated","addMenuRichWorkspace","descriptionFile","loadState","addNewFileMenuEntry","NewMenuEntryCategory","context","Permission","content","contentNames","node","showError","source","response","axios","fileid","File","getCurrentUser","showSuccess","emit","vm","FilesWorkspaceHeader","Header","_","view","el","folder","hasRichWorkspace","dirname","RichWorkspace","module","View","store"],"ignoreList":[0],"sources":["../node_modules/@mdi/svg/svg/text.svg?raw","../src/helpers/files.js"],"sourcesContent":["export default \"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" id=\\\"mdi-text\\\" viewBox=\\\"0 0 24 24\\\"><path d=\\\"M21,6V8H3V6H21M3,18H12V16H3V18M3,13H21V11H3V13Z\\\" /></svg>\"","/**\n * SPDX-FileCopyrightText: 2019 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport { dirname } from 'path'\nimport { emit } from '@nextcloud/event-bus'\nimport { getCurrentUser } from '@nextcloud/auth'\nimport { getSharingToken } from '@nextcloud/sharing/public'\nimport { Header, addNewFileMenuEntry, Permission, File, NewMenuEntryCategory } from '@nextcloud/files'\nimport { imagePath } from '@nextcloud/router'\nimport { loadState } from '@nextcloud/initial-state'\nimport { showSuccess, showError } from '@nextcloud/dialogs'\nimport axios from '@nextcloud/axios'\n\nimport TextSvg from '@mdi/svg/svg/text.svg?raw'\n\nimport { openMimetypes } from './mime.js'\nimport store from '../store/index.js'\n\nconst FILE_ACTION_IDENTIFIER = 'Edit with text app'\n\nconst registerFileCreate = () => {\n\tconst newFileMenuPlugin = {\n\t\tattach(menu) {\n\t\t\tconst fileList = menu.fileList\n\n\t\t\t// only attach to main file list, public view is not supported yet\n\t\t\tif (fileList.id !== 'files' && fileList.id !== 'files.public') {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// register the new menu entry\n\t\t\tmenu.addMenuEntry({\n\t\t\t\tid: 'file',\n\t\t\t\tdisplayName: t('text', 'New text file'),\n\t\t\t\ttemplateName: t('text', 'New text file') + '.' + loadState('text', 'default_file_extension'),\n\t\t\t\ticonClass: 'icon-filetype-text',\n\t\t\t\tfileType: 'file',\n\t\t\t\tactionLabel: t('text', 'Create new text file'),\n\t\t\t\tactionHandler(name) {\n\t\t\t\t\tfileList.createFile(name).then(function(status, data) {\n\t\t\t\t\t\tconst fileInfoModel = new OCA.Files.FileInfoModel(data)\n\t\t\t\t\t\tif (typeof OCA.Viewer !== 'undefined') {\n\t\t\t\t\t\t\tOCA.Files.fileActions.triggerAction('view', fileInfoModel, fileList)\n\t\t\t\t\t\t} else if (typeof OCA.Viewer === 'undefined') {\n\t\t\t\t\t\t\tOCA.Files.fileActions.triggerAction(FILE_ACTION_IDENTIFIER, fileInfoModel, fileList)\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t})\n\t\t},\n\t}\n\tOC.Plugins.register('OCA.Files.NewFileMenu', newFileMenuPlugin)\n}\n\nconst registerFileActionFallback = () => {\n\tconst sharingToken = getSharingToken()\n\tconst filesTable = document.querySelector('#preview table.files-filestable')\n\tif (!sharingToken || !filesTable) {\n\t\tconst ViewerRoot = document.createElement('div')\n\t\tViewerRoot.id = 'text-viewer-fallback'\n\t\tdocument.body.appendChild(ViewerRoot)\n\t\tconst registerAction = (mime) => OCA.Files.fileActions.register(\n\t\t\tmime,\n\t\t\tFILE_ACTION_IDENTIFIER,\n\t\t\tOC.PERMISSION_UPDATE | OC.PERMISSION_READ,\n\t\t\timagePath('core', 'actions/rename'),\n\t\t\t(filename) => {\n\t\t\t\tconst file = window.FileList.findFile(filename)\n\t\t\t\tPromise.all([\n\t\t\t\t\timport('vue'),\n\t\t\t\t\timport(/* webpackChunkName: \"files-modal\" */'./../components/PublicFilesEditor.vue'),\n\t\t\t\t]).then((imports) => {\n\t\t\t\t\tconst path = window.FileList.getCurrentDirectory() + '/' + filename\n\t\t\t\t\tconst Vue = imports[0].default\n\t\t\t\t\tVue.prototype.t = window.t\n\t\t\t\t\tVue.prototype.n = window.n\n\t\t\t\t\tVue.prototype.OCA = window.OCA\n\t\t\t\t\tconst Editor = imports[1].default\n\t\t\t\t\tconst vm = new Vue({\n\t\t\t\t\t\trender: function(h) { // eslint-disable-line\n\t\t\t\t\t\t\tconst self = this\n\t\t\t\t\t\t\treturn h(Editor, {\n\t\t\t\t\t\t\t\tprops: {\n\t\t\t\t\t\t\t\t\tfileId: file ? file.id : null,\n\t\t\t\t\t\t\t\t\tactive: true,\n\t\t\t\t\t\t\t\t\tshareToken: sharingToken,\n\t\t\t\t\t\t\t\t\trelativePath: path,\n\t\t\t\t\t\t\t\t\tmimeType: file.mimetype,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\ton: {\n\t\t\t\t\t\t\t\t\tclose: function() { // eslint-disable-line\n\t\t\t\t\t\t\t\t\t\tself.$destroy()\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t\tvm.$mount(ViewerRoot)\n\t\t\t\t})\n\t\t\t},\n\t\t\tt('text', 'Edit'),\n\t\t)\n\n\t\tfor (let i = 0; i < openMimetypes.length; i++) {\n\t\t\tregisterAction(openMimetypes[i])\n\t\t\tOCA.Files.fileActions.setDefault(openMimetypes[i], FILE_ACTION_IDENTIFIER)\n\t\t}\n\t}\n\n}\n\nlet newWorkspaceCreated = false\n\nexport const addMenuRichWorkspace = () => {\n\tconst descriptionFile = t('text', 'Readme') + '.' + loadState('text', 'default_file_extension')\n\taddNewFileMenuEntry({\n\t\tid: 'rich-workspace-init',\n\t\tdisplayName: t('text', 'Add folder description'),\n\t\tcategory: NewMenuEntryCategory.Other,\n\t\tenabled(context) {\n\t\t\tif (Number(context.attributes['rich-workspace-file'])) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t\treturn (context.permissions & Permission.CREATE) !== 0\n\t\t},\n\t\ticonSvgInline: TextSvg,\n\t\tasync handler(context, content) {\n\t\t\tconst contentNames = content.map((node) => node.basename)\n\n\t\t\tif (contentNames.includes(descriptionFile)) {\n\t\t\t\tshowError(t('text', '\"{name}\" already exist!', { name: descriptionFile }))\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst source = context.encodedSource + '/' + encodeURIComponent(descriptionFile)\n\t\t\tconst response = await axios({\n\t\t\t\tmethod: 'PUT',\n\t\t\t\turl: source,\n\t\t\t\theaders: {\n\t\t\t\t\tOverwrite: 'F',\n\t\t\t\t},\n\t\t\t})\n\t\t\tconst fileid = parseInt(response.headers['oc-fileid'])\n\t\t\tconst file = new File({\n\t\t\t\tsource: context.source + '/' + descriptionFile,\n\t\t\t\tid: fileid,\n\t\t\t\tmtime: new Date(),\n\t\t\t\tmime: 'text/markdown',\n\t\t\t\towner: getCurrentUser()?.uid || null,\n\t\t\t\tpermissions: Permission.ALL,\n\t\t\t\troot: context?.root || '/files/' + getCurrentUser()?.uid,\n\t\t\t})\n\n\t\t\tshowSuccess(t('text', 'Created \"{name}\"', { name: descriptionFile }))\n\n\t\t\tif (contentNames.length === 0) {\n\t\t\t\t// We currently have no way to reliably trigger the filelist header rendering\n\t\t\t\t// When starting off in a new empty folder the header will only be rendered on a new PROPFIND\n\t\t\t\tnewWorkspaceCreated = file\n\t\t\t}\n\t\t\temit('files:node:created', file)\n\t\t},\n\t})\n}\n\nlet vm = null\n\nexport const FilesWorkspaceHeader = new Header({\n\tid: 'workspace',\n\torder: 10,\n\n\tenabled(_, view) {\n\t\treturn ['files', 'favorites', 'public-share'].includes(view.id)\n\t},\n\n\tasync render(el, folder, view) {\n\t\tif (vm) {\n\t\t\t// Enforce destroying of the old rendering and rerender as the FilesListHeader calls render on every folder change\n\t\t\tvm.$destroy()\n\t\t\tvm = null\n\t\t}\n\t\tconst hasRichWorkspace = !!folder.attributes['rich-workspace-file'] || !!newWorkspaceCreated\n\t\tconst path = newWorkspaceCreated ? dirname(newWorkspaceCreated.path) : folder.path\n\t\tconst content = newWorkspaceCreated ? '' : folder.attributes['rich-workspace']\n\n\t\tnewWorkspaceCreated = false\n\n\t\tconst { default: RichWorkspace } = await import('./../views/RichWorkspace.vue')\n\n\t\timport('vue').then((module) => {\n\t\t\tel.id = 'files-workspace-wrapper'\n\n\t\t\t// Todo: remove this hack\n\t\t\tconst Vue = module.default\n\t\t\tVue.prototype.t = window.t\n\t\t\tVue.prototype.n = window.n\n\t\t\tVue.prototype.OCA = window.OCA\n\n\t\t\tconst View = Vue.extend(RichWorkspace)\n\t\t\tvm = new View({\n\t\t\t\tpropsData: {\n\t\t\t\t\tpath,\n\t\t\t\t\thasRichWorkspace,\n\t\t\t\t\tcontent,\n\t\t\t\t},\n\t\t\t\tstore,\n\t\t\t}).$mount(el)\n\t\t})\n\t},\n\n\tupdated(folder, view) {\n\t\tnewWorkspaceCreated = false\n\n\t\tif (!vm) {\n\t\t\tconsole.warn('No vue instance found for FilesWorkspaceHeader')\n\t\t\treturn\n\t\t}\n\n\t\t// Currently there is not much use in updating the vue instance props since render is called on every folder change\n\t\t// removing the rendered element from the DOM\n\t\t// This is only relevant if switching to a folder that has no content as then the render function is not called\n\n\t\tconst hasRichWorkspace = !!folder.attributes['rich-workspace-file']\n\t\tvm.path = folder.path\n\t\tvm.hasRichWorkspace = hasRichWorkspace\n\t\tvm.content = folder.attributes['rich-workspace']\n\t},\n})\n\nexport {\n\tregisterFileActionFallback,\n\tregisterFileCreate,\n\tFILE_ACTION_IDENTIFIER,\n}\n"],"file":"js/files-D67rn9b2.chunk.mjs"}