import{f as j,g as k,M as A,h as _,i as G,R as H,F as W,c as z,d as F,p as q,j as K}from"./EditorOutline-C4Z6-9-r.chunk.mjs";import{W as N,M as U,a as V,R as J,C as L,A as Q}from"./MenuBar-D9PZRYXo.chunk.mjs";import{a as X}from"./index-gMaV0V1e.chunk.mjs";import{w as b,p as Y}from"./vue.runtime.esm-UAI8SE-v.chunk.mjs";import{A as Z}from"./MediaHandler.provider-B-6EH1Bu.chunk.mjs";import{n as ee}from"./_plugin-vue2_normalizer-XSZyZ-Zg.chunk.mjs";import"./NcLoadingIcon-pzx-bM2e.chunk.mjs";import"./emoji-picker-DQhTjoLy.chunk.mjs";import"./index-DUrHmx5a.chunk.mjs";import"./logger-DH1Ckv9w.chunk.mjs";import"./index-B64e8dYD.chunk.mjs";import"./NcNoteCard-Dz5-u2BY-DlVQ92TX.chunk.mjs";import"./NcCheckboxRadioSwitch-CLnWsBwK-De_MbaV5.chunk.mjs";var I=200,u=function(){};u.prototype.append=function(n){return n.length?(n=u.from(n),!this.length&&n||n.length<I&&this.leafAppend(n)||this.length<I&&n.leafPrepend(this)||this.appendInner(n)):this},u.prototype.prepend=function(n){return n.length?u.from(n).append(this):this},u.prototype.appendInner=function(n){return new te(this,n)},u.prototype.slice=function(n,e){return n===void 0&&(n=0),e===void 0&&(e=this.length),n>=e?u.empty:this.sliceInner(Math.max(0,n),Math.min(this.length,e))},u.prototype.get=function(n){if(!(n<0||n>=this.length))return this.getInner(n)},u.prototype.forEach=function(n,e,t){e===void 0&&(e=0),t===void 0&&(t=this.length),e<=t?this.forEachInner(n,e,t,0):this.forEachInvertedInner(n,e,t,0)},u.prototype.map=function(n,e,t){e===void 0&&(e=0),t===void 0&&(t=this.length);var i=[];return this.forEach(function(o,r){return i.push(n(o,r))},e,t),i},u.from=function(n){return n instanceof u?n:n&&n.length?new B(n):u.empty};var B=function(n){function e(i){n.call(this),this.values=i}n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e;var t={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(i,o){return i==0&&o==this.length?this:new e(this.values.slice(i,o))},e.prototype.getInner=function(i){return this.values[i]},e.prototype.forEachInner=function(i,o,r,s){for(var a=o;a<r;a++)if(i(this.values[a],s+a)===!1)return!1},e.prototype.forEachInvertedInner=function(i,o,r,s){for(var a=o-1;a>=r;a--)if(i(this.values[a],s+a)===!1)return!1},e.prototype.leafAppend=function(i){if(this.length+i.length<=I)return new e(this.values.concat(i.flatten()))},e.prototype.leafPrepend=function(i){if(this.length+i.length<=I)return new e(i.flatten().concat(this.values))},t.length.get=function(){return this.values.length},t.depth.get=function(){return 0},Object.defineProperties(e.prototype,t),e}(u);u.empty=new B([]);var te=function(n){function e(t,i){n.call(this),this.left=t,this.right=i,this.length=t.length+i.length,this.depth=Math.max(t.depth,i.depth)+1}return n&&(e.__proto__=n),e.prototype=Object.create(n&&n.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(t){return t<this.left.length?this.left.get(t):this.right.get(t-this.left.length)},e.prototype.forEachInner=function(t,i,o,r){var s=this.left.length;if(i<s&&this.left.forEachInner(t,i,Math.min(o,s),r)===!1||o>s&&this.right.forEachInner(t,Math.max(i-s,0),Math.min(this.length,o)-s,r+s)===!1)return!1},e.prototype.forEachInvertedInner=function(t,i,o,r){var s=this.left.length;if(i>s&&this.right.forEachInvertedInner(t,i-s,Math.max(o,s)-s,r+s)===!1||o<s&&this.left.forEachInvertedInner(t,Math.min(i,s),o,r)===!1)return!1},e.prototype.sliceInner=function(t,i){if(t==0&&i==this.length)return this;var o=this.left.length;return i<=o?this.left.slice(t,i):t>=o?this.right.slice(t-o,i-o):this.left.slice(t,o).append(this.right.slice(0,i-o))},e.prototype.leafAppend=function(t){var i=this.right.leafAppend(t);if(i)return new e(this.left,i)},e.prototype.leafPrepend=function(t){var i=this.left.leafPrepend(t);if(i)return new e(i,this.right)},e.prototype.appendInner=function(t){return this.left.depth>=Math.max(this.right.depth,t.depth)+1?new e(this.left,new e(this.right,t)):new e(this,t)},e}(u),P=u;const ne=500;class m{constructor(e,t){this.items=e,this.eventCount=t}popEvent(e,t){if(this.eventCount==0)return null;let i=this.items.length;for(;;i--)if(this.items.get(i-1).selection){--i;break}let o,r;t&&(o=this.remapping(i,this.items.length),r=o.maps.length);let s=e.tr,a,h,d=[],c=[];return this.items.forEach((l,p)=>{if(!l.step){o||(o=this.remapping(i,p+1),r=o.maps.length),r--,c.push(l);return}if(o){c.push(new g(l.map));let f=l.step.map(o.slice(r)),y;f&&s.maybeStep(f).doc&&(y=s.mapping.maps[s.mapping.maps.length-1],d.push(new g(y,void 0,void 0,d.length+c.length))),r--,y&&o.appendMap(y,r)}else s.maybeStep(l.step);if(l.selection)return a=o?l.selection.map(o.slice(r)):l.selection,h=new m(this.items.slice(0,i).append(c.reverse().concat(d)),this.eventCount-1),!1},this.items.length,0),{remaining:h,transform:s,selection:a}}addTransform(e,t,i,o){let r=[],s=this.eventCount,a=this.items,h=!o&&a.length?a.get(a.length-1):null;for(let c=0;c<e.steps.length;c++){let l=e.steps[c].invert(e.docs[c]),p=new g(e.mapping.maps[c],l,t),f;(f=h&&h.merge(p))&&(p=f,c?r.pop():a=a.slice(0,a.length-1)),r.push(p),t&&(s++,t=void 0),o||(h=p)}let d=s-i.depth;return d>oe&&(a=ie(a,d),s-=d),new m(a.append(r),s)}remapping(e,t){let i=new A;return this.items.forEach((o,r)=>{let s=o.mirrorOffset!=null&&r-o.mirrorOffset>=e?i.maps.length-o.mirrorOffset:void 0;i.appendMap(o.map,s)},e,t),i}addMaps(e){return this.eventCount==0?this:new m(this.items.append(e.map(t=>new g(t))),this.eventCount)}rebased(e,t){if(!this.eventCount)return this;let i=[],o=Math.max(0,this.items.length-t),r=e.mapping,s=e.steps.length,a=this.eventCount;this.items.forEach(p=>{p.selection&&a--},o);let h=t;this.items.forEach(p=>{let f=r.getMirror(--h);if(f==null)return;s=Math.min(s,f);let y=r.maps[f];if(p.step){let $=e.steps[f].invert(e.docs[f]),T=p.selection&&p.selection.map(r.slice(h+1,f));T&&a++,i.push(new g(y,$,T))}else i.push(new g(y))},o);let d=[];for(let p=t;p<s;p++)d.push(new g(r.maps[p]));let c=this.items.slice(0,o).append(d).append(i),l=new m(c,a);return l.emptyItemCount()>ne&&(l=l.compress(this.items.length-i.length)),l}emptyItemCount(){let e=0;return this.items.forEach(t=>{t.step||e++}),e}compress(e=this.items.length){let t=this.remapping(0,e),i=t.maps.length,o=[],r=0;return this.items.forEach((s,a)=>{if(a>=e)o.push(s),s.selection&&r++;else if(s.step){let h=s.step.map(t.slice(i)),d=h&&h.getMap();if(i--,d&&t.appendMap(d,i),h){let c=s.selection&&s.selection.map(t.slice(i));c&&r++;let l=new g(d.invert(),h,c),p,f=o.length-1;(p=o.length&&o[f].merge(l))?o[f]=p:o.push(l)}}else s.map&&i--},this.items.length,0),new m(P.from(o.reverse()),r)}}m.empty=new m(P.empty,0);function ie(n,e){let t;return n.forEach((i,o)=>{if(i.selection&&e--==0)return t=o,!1}),n.slice(t)}class g{constructor(e,t,i,o){this.map=e,this.step=t,this.selection=i,this.mirrorOffset=o}merge(e){if(this.step&&e.step&&!e.selection){let t=e.step.merge(this.step);if(t)return new g(t.getMap().invert(),t,this.selection)}}}class v{constructor(e,t,i,o,r){this.done=e,this.undone=t,this.prevRanges=i,this.prevTime=o,this.prevComposition=r}}const oe=20;function re(n,e,t,i){let o=t.getMeta(w),r;if(o)return o.historyState;t.getMeta(pe)&&(n=new v(n.done,n.undone,null,0,-1));let s=t.getMeta("appendedTransaction");if(t.steps.length==0)return n;if(s&&s.getMeta(w))return s.getMeta(w).redo?new v(n.done.addTransform(t,void 0,i,M(e)),n.undone,O(t.mapping.maps),n.prevTime,n.prevComposition):new v(n.done,n.undone.addTransform(t,void 0,i,M(e)),null,n.prevTime,n.prevComposition);if(t.getMeta("addToHistory")!==!1&&!(s&&s.getMeta("addToHistory")===!1)){let a=t.getMeta("composition"),h=n.prevTime==0||!s&&n.prevComposition!=a&&(n.prevTime<(t.time||0)-i.newGroupDelay||!se(t,n.prevRanges)),d=s?C(n.prevRanges,t.mapping):O(t.mapping.maps);return new v(n.done.addTransform(t,h?e.selection.getBookmark():void 0,i,M(e)),m.empty,d,t.time,a!=null?a:n.prevComposition)}else return(r=t.getMeta("rebased"))?new v(n.done.rebased(t,r),n.undone.rebased(t,r),C(n.prevRanges,t.mapping),n.prevTime,n.prevComposition):new v(n.done.addMaps(t.mapping.maps),n.undone.addMaps(t.mapping.maps),C(n.prevRanges,t.mapping),n.prevTime,n.prevComposition)}function se(n,e){if(!e)return!1;if(!n.docChanged)return!0;let t=!1;return n.mapping.maps[0].forEach((i,o)=>{for(let r=0;r<e.length;r+=2)i<=e[r+1]&&o>=e[r]&&(t=!0)}),t}function O(n){let e=[];for(let t=n.length-1;t>=0&&e.length==0;t--)n[t].forEach((i,o,r,s)=>e.push(r,s));return e}function C(n,e){if(!n)return null;let t=[];for(let i=0;i<n.length;i+=2){let o=e.map(n[i],1),r=e.map(n[i+1],-1);o<=r&&t.push(o,r)}return t}function ae(n,e,t){let i=M(e),o=w.get(e).spec.config,r=(t?n.undone:n.done).popEvent(e,i);if(!r)return null;let s=r.selection.resolve(r.transform.doc),a=(t?n.done:n.undone).addTransform(r.transform,e.selection.getBookmark(),o,i),h=new v(t?a:r.remaining,t?r.remaining:a,null,0,-1);return r.transform.setSelection(s).setMeta(w,{redo:t,historyState:h})}let E=!1,R=null;function M(n){let e=n.plugins;if(R!=e){E=!1,R=e;for(let t=0;t<e.length;t++)if(e[t].spec.historyPreserveItems){E=!0;break}}return E}const w=new k("history"),pe=new k("closeHistory");function he(n={}){return n={depth:n.depth||100,newGroupDelay:n.newGroupDelay||500},new j({key:w,state:{init(){return new v(m.empty,m.empty,null,0,-1)},apply(e,t,i){return re(t,i,e,n)}},config:n,props:{handleDOMEvents:{beforeinput(e,t){let i=t.inputType,o=i=="historyUndo"?x:i=="historyRedo"?D:null;return o?(t.preventDefault(),o(e.state,e.dispatch)):!1}}}})}function S(n,e){return(t,i)=>{let o=w.getState(t);if(!o||(n?o.undone:o.done).eventCount==0)return!1;if(i){let r=ae(o,t,n);r&&i(e?r.scrollIntoView():r)}return!0}}const x=S(!1,!0),D=S(!0,!0),le=_.create({name:"history",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:n,dispatch:e})=>x(n,e),redo:()=>({state:n,dispatch:e})=>D(n,e)}},addProseMirrorPlugins(){return[he(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-y":()=>this.editor.commands.redo(),"Mod-я":()=>this.editor.commands.undo(),"Shift-Mod-я":()=>this.editor.commands.redo()}}}),ue={name:"MarkdownContentEditor",components:{ContentContainer:L,ReadonlyBar:J,MenuBar:V,MainContainer:U,Wrapper:N},provide(){const n={};return Object.defineProperties(n,{[Z]:{get:()=>{var e;return(e=this.$attachmentResolver)!=null?e:null}}}),n},props:{fileId:{type:Number,default:null},content:{type:String,required:!0},readOnly:{type:Boolean,default:!1},relativePath:{type:String,default:""},shareToken:{type:String,default:null},showMenuBar:{type:Boolean,default:!0},showOutlineOutside:{type:Boolean,default:!1}},emits:["update:content"],setup(n){const e=[H.configure({extensions:[le]}),W],t=new z({extensions:e}),{setEditable:i,setContent:o}=F(t);return b(()=>n.content,r=>{o(r)}),i(!n.readOnly),b(()=>n.readOnly,r=>{i(!r)}),q(t),Y(K,{isPublic:!1,isRichEditor:!0,isRichWorkspace:!1}),{editor:t,setContent:o}},created(){var n;this.setContent(this.content,{addToHistory:!1}),this.editor.on("create",()=>{this.$emit("ready"),this.$parent.$emit("ready")}),this.editor.on("update",({editor:e})=>{const t=G(e.schema).serialize(e.state.doc);this.emit("update:content",{json:e.state.doc,markdown:t})}),this.fileId&&(this.$attachmentResolver=new Q({currentDirectory:(n=this.relativePath)==null?void 0:n.match(/.*\//),user:X(),shareToken:this.shareToken,fileId:this.fileId}))},beforeDestroy(){this.editor.destroy()},methods:{outlineToggled(n){this.emit("outline-toggled",n)},emit(n,e){var t;this.$emit(n,e),(t=this.$parent)==null||t.$emit(n,e)}}};var de=function(){var n=this,e=n._self._c;return e("Wrapper",{attrs:{"content-loaded":!0,"show-outline-outside":n.showOutlineOutside},on:{"outline-toggled":n.outlineToggled}},[e("MainContainer",[n.showMenuBar?[n.readOnly?n._t("readonlyBar",function(){return[e("ReadonlyBar")]}):e("MenuBar",{attrs:{autohide:!1}})]:n._e(),e("ContentContainer")],2)],1)},ce=[],fe=ee(ue,de,ce,!1,null,null);const ke=fe.exports;export{ke as default};
//# sourceMappingURL=MarkdownContentEditor-BtTEcQpy.chunk.mjs.map
