import{f as j,g as k,M as A,h as _,i as G,R as W,F as z,c as F,m as H,d as q,p as K,j as N}from"./EditorOutline-B8WwhBwY.chunk.mjs";import{W as U,M as V,a as J,R as L,C as Q,A as X}from"./MenuBar-BfeKIy_A.chunk.mjs";import{a as Y}from"./index-6AQ8QgJK.chunk.mjs";import{w as b,p as Z}from"./vue.runtime.esm-C9BcAUzb.chunk.mjs";import{A as ee}from"./MediaHandler.provider-5Sq8d96G.chunk.mjs";import{n as te}from"./_plugin-vue2_normalizer-XSZyZ-Zg.chunk.mjs";import"./NcLoadingIcon-CJE64hP2.chunk.mjs";import"./emoji-picker-DwlFXcXb.chunk.mjs";import"./index-CCUE3e_p.chunk.mjs";import"./logger-DVPLBGl3.chunk.mjs";import"./index-B8nYQ_zQ.chunk.mjs";import"./NcNoteCard-ChweF_5Q-BlJ_YGPS.chunk.mjs";import"./NcCheckboxRadioSwitch-ip_mRd2T-Dfp99Ypv.chunk.mjs";var I=200,u=function(){};u.prototype.append=function(t){return t.length?(t=u.from(t),!this.length&&t||t.length<I&&this.leafAppend(t)||this.length<I&&t.leafPrepend(this)||this.appendInner(t)):this},u.prototype.prepend=function(t){return t.length?u.from(t).append(this):this},u.prototype.appendInner=function(t){return new ne(this,t)},u.prototype.slice=function(t,e){return t===void 0&&(t=0),e===void 0&&(e=this.length),t>=e?u.empty:this.sliceInner(Math.max(0,t),Math.min(this.length,e))},u.prototype.get=function(t){if(!(t<0||t>=this.length))return this.getInner(t)},u.prototype.forEach=function(t,e,n){e===void 0&&(e=0),n===void 0&&(n=this.length),e<=n?this.forEachInner(t,e,n,0):this.forEachInvertedInner(t,e,n,0)},u.prototype.map=function(t,e,n){e===void 0&&(e=0),n===void 0&&(n=this.length);var r=[];return this.forEach(function(i,o){return r.push(t(i,o))},e,n),r},u.from=function(t){return t instanceof u?t:t&&t.length?new B(t):u.empty};var B=function(t){function e(r){t.call(this),this.values=r}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={length:{configurable:!0},depth:{configurable:!0}};return e.prototype.flatten=function(){return this.values},e.prototype.sliceInner=function(r,i){return r==0&&i==this.length?this:new e(this.values.slice(r,i))},e.prototype.getInner=function(r){return this.values[r]},e.prototype.forEachInner=function(r,i,o,s){for(var a=i;a<o;a++)if(r(this.values[a],s+a)===!1)return!1},e.prototype.forEachInvertedInner=function(r,i,o,s){for(var a=i-1;a>=o;a--)if(r(this.values[a],s+a)===!1)return!1},e.prototype.leafAppend=function(r){if(this.length+r.length<=I)return new e(this.values.concat(r.flatten()))},e.prototype.leafPrepend=function(r){if(this.length+r.length<=I)return new e(r.flatten().concat(this.values))},n.length.get=function(){return this.values.length},n.depth.get=function(){return 0},Object.defineProperties(e.prototype,n),e}(u);u.empty=new B([]);var ne=function(t){function e(n,r){t.call(this),this.left=n,this.right=r,this.length=n.length+r.length,this.depth=Math.max(n.depth,r.depth)+1}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.flatten=function(){return this.left.flatten().concat(this.right.flatten())},e.prototype.getInner=function(n){return n<this.left.length?this.left.get(n):this.right.get(n-this.left.length)},e.prototype.forEachInner=function(n,r,i,o){var s=this.left.length;if(r<s&&this.left.forEachInner(n,r,Math.min(i,s),o)===!1||i>s&&this.right.forEachInner(n,Math.max(r-s,0),Math.min(this.length,i)-s,o+s)===!1)return!1},e.prototype.forEachInvertedInner=function(n,r,i,o){var s=this.left.length;if(r>s&&this.right.forEachInvertedInner(n,r-s,Math.max(i,s)-s,o+s)===!1||i<s&&this.left.forEachInvertedInner(n,Math.min(r,s),i,o)===!1)return!1},e.prototype.sliceInner=function(n,r){if(n==0&&r==this.length)return this;var i=this.left.length;return r<=i?this.left.slice(n,r):n>=i?this.right.slice(n-i,r-i):this.left.slice(n,i).append(this.right.slice(0,r-i))},e.prototype.leafAppend=function(n){var r=this.right.leafAppend(n);if(r)return new e(this.left,r)},e.prototype.leafPrepend=function(n){var r=this.left.leafPrepend(n);if(r)return new e(r,this.right)},e.prototype.appendInner=function(n){return this.left.depth>=Math.max(this.right.depth,n.depth)+1?new e(this.left,new e(this.right,n)):new e(this,n)},e}(u),P=u;const re=500;class m{constructor(e,n){this.items=e,this.eventCount=n}popEvent(e,n){if(this.eventCount==0)return null;let r=this.items.length;for(;;r--)if(this.items.get(r-1).selection){--r;break}let i,o;n&&(i=this.remapping(r,this.items.length),o=i.maps.length);let s=e.tr,a,h,d=[],c=[];return this.items.forEach((l,p)=>{if(!l.step){i||(i=this.remapping(r,p+1),o=i.maps.length),o--,c.push(l);return}if(i){c.push(new g(l.map));let f=l.step.map(i.slice(o)),y;f&&s.maybeStep(f).doc&&(y=s.mapping.maps[s.mapping.maps.length-1],d.push(new g(y,void 0,void 0,d.length+c.length))),o--,y&&i.appendMap(y,o)}else s.maybeStep(l.step);if(l.selection)return a=i?l.selection.map(i.slice(o)):l.selection,h=new m(this.items.slice(0,r).append(c.reverse().concat(d)),this.eventCount-1),!1},this.items.length,0),{remaining:h,transform:s,selection:a}}addTransform(e,n,r,i){let o=[],s=this.eventCount,a=this.items,h=!i&&a.length?a.get(a.length-1):null;for(let c=0;c<e.steps.length;c++){let l=e.steps[c].invert(e.docs[c]),p=new g(e.mapping.maps[c],l,n),f;(f=h&&h.merge(p))&&(p=f,c?o.pop():a=a.slice(0,a.length-1)),o.push(p),n&&(s++,n=void 0),i||(h=p)}let d=s-r.depth;return d>oe&&(a=ie(a,d),s-=d),new m(a.append(o),s)}remapping(e,n){let r=new A;return this.items.forEach((i,o)=>{let s=i.mirrorOffset!=null&&o-i.mirrorOffset>=e?r.maps.length-i.mirrorOffset:void 0;r.appendMap(i.map,s)},e,n),r}addMaps(e){return this.eventCount==0?this:new m(this.items.append(e.map(n=>new g(n))),this.eventCount)}rebased(e,n){if(!this.eventCount)return this;let r=[],i=Math.max(0,this.items.length-n),o=e.mapping,s=e.steps.length,a=this.eventCount;this.items.forEach(p=>{p.selection&&a--},i);let h=n;this.items.forEach(p=>{let f=o.getMirror(--h);if(f==null)return;s=Math.min(s,f);let y=o.maps[f];if(p.step){let $=e.steps[f].invert(e.docs[f]),T=p.selection&&p.selection.map(o.slice(h+1,f));T&&a++,r.push(new g(y,$,T))}else r.push(new g(y))},i);let d=[];for(let p=n;p<s;p++)d.push(new g(o.maps[p]));let c=this.items.slice(0,i).append(d).append(r),l=new m(c,a);return l.emptyItemCount()>re&&(l=l.compress(this.items.length-r.length)),l}emptyItemCount(){let e=0;return this.items.forEach(n=>{n.step||e++}),e}compress(e=this.items.length){let n=this.remapping(0,e),r=n.maps.length,i=[],o=0;return this.items.forEach((s,a)=>{if(a>=e)i.push(s),s.selection&&o++;else if(s.step){let h=s.step.map(n.slice(r)),d=h&&h.getMap();if(r--,d&&n.appendMap(d,r),h){let c=s.selection&&s.selection.map(n.slice(r));c&&o++;let l=new g(d.invert(),h,c),p,f=i.length-1;(p=i.length&&i[f].merge(l))?i[f]=p:i.push(l)}}else s.map&&r--},this.items.length,0),new m(P.from(i.reverse()),o)}}m.empty=new m(P.empty,0);function ie(t,e){let n;return t.forEach((r,i)=>{if(r.selection&&e--==0)return n=i,!1}),t.slice(n)}class g{constructor(e,n,r,i){this.map=e,this.step=n,this.selection=r,this.mirrorOffset=i}merge(e){if(this.step&&e.step&&!e.selection){let n=e.step.merge(this.step);if(n)return new g(n.getMap().invert(),n,this.selection)}}}class v{constructor(e,n,r,i,o){this.done=e,this.undone=n,this.prevRanges=r,this.prevTime=i,this.prevComposition=o}}const oe=20;function se(t,e,n,r){let i=n.getMeta(w),o;if(i)return i.historyState;n.getMeta(he)&&(t=new v(t.done,t.undone,null,0,-1));let s=n.getMeta("appendedTransaction");if(n.steps.length==0)return t;if(s&&s.getMeta(w))return s.getMeta(w).redo?new v(t.done.addTransform(n,void 0,r,M(e)),t.undone,O(n.mapping.maps),t.prevTime,t.prevComposition):new v(t.done,t.undone.addTransform(n,void 0,r,M(e)),null,t.prevTime,t.prevComposition);if(n.getMeta("addToHistory")!==!1&&!(s&&s.getMeta("addToHistory")===!1)){let a=n.getMeta("composition"),h=t.prevTime==0||!s&&t.prevComposition!=a&&(t.prevTime<(n.time||0)-r.newGroupDelay||!ae(n,t.prevRanges)),d=s?C(t.prevRanges,n.mapping):O(n.mapping.maps);return new v(t.done.addTransform(n,h?e.selection.getBookmark():void 0,r,M(e)),m.empty,d,n.time,a??t.prevComposition)}else return(o=n.getMeta("rebased"))?new v(t.done.rebased(n,o),t.undone.rebased(n,o),C(t.prevRanges,n.mapping),t.prevTime,t.prevComposition):new v(t.done.addMaps(n.mapping.maps),t.undone.addMaps(n.mapping.maps),C(t.prevRanges,n.mapping),t.prevTime,t.prevComposition)}function ae(t,e){if(!e)return!1;if(!t.docChanged)return!0;let n=!1;return t.mapping.maps[0].forEach((r,i)=>{for(let o=0;o<e.length;o+=2)r<=e[o+1]&&i>=e[o]&&(n=!0)}),n}function O(t){let e=[];for(let n=t.length-1;n>=0&&e.length==0;n--)t[n].forEach((r,i,o,s)=>e.push(o,s));return e}function C(t,e){if(!t)return null;let n=[];for(let r=0;r<t.length;r+=2){let i=e.map(t[r],1),o=e.map(t[r+1],-1);i<=o&&n.push(i,o)}return n}function pe(t,e,n){let r=M(e),i=w.get(e).spec.config,o=(n?t.undone:t.done).popEvent(e,r);if(!o)return null;let s=o.selection.resolve(o.transform.doc),a=(n?t.done:t.undone).addTransform(o.transform,e.selection.getBookmark(),i,r),h=new v(n?a:o.remaining,n?o.remaining:a,null,0,-1);return o.transform.setSelection(s).setMeta(w,{redo:n,historyState:h})}let E=!1,R=null;function M(t){let e=t.plugins;if(R!=e){E=!1,R=e;for(let n=0;n<e.length;n++)if(e[n].spec.historyPreserveItems){E=!0;break}}return E}const w=new k("history"),he=new k("closeHistory");function le(t={}){return t={depth:t.depth||100,newGroupDelay:t.newGroupDelay||500},new j({key:w,state:{init(){return new v(m.empty,m.empty,null,0,-1)},apply(e,n,r){return se(n,r,e,t)}},config:t,props:{handleDOMEvents:{beforeinput(e,n){let r=n.inputType,i=r=="historyUndo"?x:r=="historyRedo"?D:null;return i?(n.preventDefault(),i(e.state,e.dispatch)):!1}}}})}function S(t,e){return(n,r)=>{let i=w.getState(n);if(!i||(t?i.undone:i.done).eventCount==0)return!1;if(r){let o=pe(i,n,t);o&&r(e?o.scrollIntoView():o)}return!0}}const x=S(!1,!0),D=S(!0,!0),ue=_.create({name:"history",addOptions(){return{depth:100,newGroupDelay:500}},addCommands(){return{undo:()=>({state:t,dispatch:e})=>x(t,e),redo:()=>({state:t,dispatch:e})=>D(t,e)}},addProseMirrorPlugins(){return[le(this.options)]},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Shift-Mod-z":()=>this.editor.commands.redo(),"Mod-y":()=>this.editor.commands.redo(),"Mod-я":()=>this.editor.commands.undo(),"Shift-Mod-я":()=>this.editor.commands.redo()}}}),de={name:"MarkdownContentEditor",components:{ContentContainer:Q,ReadonlyBar:L,MenuBar:J,MainContainer:V,Wrapper:U},provide(){const t={};return Object.defineProperties(t,{[ee]:{get:()=>this.$attachmentResolver??null}}),t},props:{fileId:{type:Number,default:null},content:{type:String,required:!0},readOnly:{type:Boolean,default:!1},relativePath:{type:String,default:""},shareToken:{type:String,default:null},showMenuBar:{type:Boolean,default:!0},showOutlineOutside:{type:Boolean,default:!1}},emits:["update:content"],setup(t){const e=[W.configure({extensions:[ue]}),z],n=new F({content:H.render(t.content),extensions:e}),{setEditable:r,setContent:i}=q(n);return b(()=>t.content,o=>{i(o)}),r(!t.readOnly),b(()=>t.readOnly,o=>{r(!o)}),K(n),Z(N,{isPublic:!1,isRichEditor:!0,isRichWorkspace:!1}),{editor:n}},created(){this.editor.on("create",()=>{this.$emit("ready"),this.$parent.$emit("ready")}),this.editor.on("update",({editor:t})=>{const e=G(t.schema).serialize(t.state.doc);this.emit("update:content",{json:t.state.doc,markdown:e})}),this.fileId&&(this.$attachmentResolver=new X({currentDirectory:this.relativePath?.match(/.*\//),user:Y(),shareToken:this.shareToken,fileId:this.fileId}))},beforeDestroy(){this.editor.destroy()},methods:{outlineToggled(t){this.emit("outline-toggled",t)},emit(t,e){this.$emit(t,e),this.$parent?.$emit(t,e)}}};var ce=function(){var t=this,e=t._self._c;return e("Wrapper",{attrs:{"content-loaded":!0,"show-outline-outside":t.showOutlineOutside},on:{"outline-toggled":t.outlineToggled}},[e("MainContainer",[t.showMenuBar?[t.readOnly?t._t("readonlyBar",function(){return[e("ReadonlyBar")]}):e("MenuBar",{attrs:{autohide:!1}})]:t._e(),e("ContentContainer")],2)],1)},fe=[],me=te(de,ce,fe,!1,null,null);const Be=me.exports;export{Be as default};
//# sourceMappingURL=MarkdownContentEditor-hcwS2kLi.chunk.mjs.map
