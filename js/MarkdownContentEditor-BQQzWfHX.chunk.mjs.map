{"version":3,"file":"MarkdownContentEditor-BQQzWfHX.chunk.mjs","sources":["../src/components/Editor/MarkdownContentEditor.vue"],"sourcesContent":["<!--\n  - SPDX-FileCopyrightText: 2022 Nextcloud GmbH and Nextcloud contributors\n  - SPDX-License-Identifier: AGPL-3.0-or-later\n-->\n\n<template>\n\t<Wrapper :content-loaded=\"true\"\n\t\t:show-outline-outside=\"showOutlineOutside\"\n\t\t@outline-toggled=\"outlineToggled\">\n\t\t<MainContainer>\n\t\t\t<template v-if=\"showMenuBar\">\n\t\t\t\t<MenuBar v-if=\"!readOnly\" :autohide=\"false\" />\n\t\t\t\t<slot v-else name=\"readonlyBar\">\n\t\t\t\t\t<ReadonlyBar />\n\t\t\t\t</slot>\n\t\t\t</template>\n\t\t\t<ContentContainer />\n\t\t</MainContainer>\n\t</Wrapper>\n</template>\n\n<script>\nimport Wrapper from './Wrapper.vue'\nimport MainContainer from './MainContainer.vue'\nimport MenuBar from '../Menu/MenuBar.vue'\nimport { Editor } from '@tiptap/core'\n/* eslint-disable import/no-named-as-default */\nimport History from '@tiptap/extension-history'\nimport { getCurrentUser } from '@nextcloud/auth'\nimport { ATTACHMENT_RESOLVER, EDITOR, IS_RICH_EDITOR } from '../Editor.provider.js'\nimport { createMarkdownSerializer } from '../../extensions/Markdown.js'\nimport AttachmentResolver from '../../services/AttachmentResolver.js'\nimport markdownit from '../../markdownit/index.js'\nimport { RichText, FocusTrap } from '../../extensions/index.js'\nimport ReadonlyBar from '../Menu/ReadonlyBar.vue'\nimport ContentContainer from './ContentContainer.vue'\n\nexport default {\n\tname: 'MarkdownContentEditor',\n\tcomponents: { ContentContainer, ReadonlyBar, MenuBar, MainContainer, Wrapper },\n\tprovide() {\n\t\tconst val = {}\n\n\t\tObject.defineProperties(val, {\n\t\t\t[EDITOR]: {\n\t\t\t\tget: () => this.$editor,\n\t\t\t},\n\t\t\t[ATTACHMENT_RESOLVER]: {\n\t\t\t\tget: () => this.$attachmentResolver ?? null,\n\t\t\t},\n\t\t\t[IS_RICH_EDITOR]: {\n\t\t\t\tget: () => true,\n\t\t\t},\n\t\t})\n\n\t\treturn val\n\t},\n\n\tprops: {\n\t\tfileId: {\n\t\t\ttype: Number,\n\t\t\tdefault: null,\n\t\t},\n\t\tcontent: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\treadOnly: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t\trelativePath: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t\tshareToken: {\n\t\t\ttype: String,\n\t\t\tdefault: null,\n\t\t},\n\t\tshowMenuBar: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true,\n\t\t},\n\t\tshowOutlineOutside: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t},\n\temits: ['update:content'],\n\n\tcomputed: {\n\t\thtmlContent() {\n\t\t\treturn this.renderHtml(this.content)\n\t\t},\n\t},\n\n\twatch: {\n\t\tcontent() {\n\t\t\tthis.updateContent()\n\t\t},\n\t},\n\n\tcreated() {\n\t\tthis.$editor = this.createEditor()\n\t\tthis.$editor.setEditable(!this.readOnly)\n\t\tif (this.fileId) {\n\t\t\tthis.$attachmentResolver = new AttachmentResolver({\n\t\t\t\tcurrentDirectory: this.relativePath?.match(/.*\\//),\n\t\t\t\tuser: getCurrentUser(),\n\t\t\t\tshareToken: this.shareToken,\n\t\t\t\tfileId: this.fileId,\n\t\t\t})\n\t\t}\n\t},\n\n\tupdated() {\n\t\tthis.$editor.setEditable(!this.readOnly)\n\t},\n\n\tbeforeDestroy() {\n\t\tthis.$editor.destroy()\n\t},\n\n\tmethods: {\n\t\trenderHtml(content) {\n\t\t\treturn markdownit.render(content)\n\t\t},\n\t\textensions() {\n\t\t\treturn [\n\t\t\t\tRichText.configure({\n\t\t\t\t\tcomponent: this,\n\t\t\t\t\textensions: [\n\t\t\t\t\t\tHistory,\n\t\t\t\t\t],\n\t\t\t\t}),\n\t\t\t\tFocusTrap,\n\t\t\t]\n\t\t},\n\t\tcreateEditor() {\n\t\t\treturn new Editor({\n\t\t\t\tcontent: this.htmlContent,\n\t\t\t\textensions: this.extensions(),\n\t\t\t\tonUpdate: ({ editor }) => {\n\t\t\t\t\tconst markdown = (createMarkdownSerializer(this.$editor.schema)).serialize(editor.state.doc)\n\t\t\t\t\tthis.emit('update:content', {\n\t\t\t\t\t\tjson: editor.state.doc,\n\t\t\t\t\t\tmarkdown,\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t\tonCreate: ({ editor }) => {\n\t\t\t\t\tthis.$emit('ready')\n\t\t\t\t\tthis.$parent.$emit('ready')\n\t\t\t\t},\n\t\t\t})\n\t\t},\n\n\t\tupdateContent() {\n\t\t\tthis.$editor.commands.setContent(this.htmlContent, true)\n\t\t},\n\n\t\toutlineToggled(visible) {\n\t\t\tthis.emit('outline-toggled', visible)\n\t\t},\n\n\t\t/**\n\t\t * Wrapper to emit events on our own and the parent component\n\t\t *\n\t\t * The parent might be either the root component of src/editor.js or Viewer.vue which collectives currently uses\n\t\t *\n\t\t * Ideally this would be done in a generic way in the src/editor.js API abstraction, but it seems\n\t\t * that there is no proper way to pass any received event along in vue, the only option I've found\n\t\t * in https://github.com/vuejs/vue/issues/230 feels too hacky to me, so we just emit twice for now\n\t\t *\n\t\t * @param {string} event The event name\n\t\t * @param {any} data The data to pass along\n\t\t */\n\t\temit(event, data) {\n\t\t\tthis.$emit(event, data)\n\t\t\tthis.$parent?.$emit(event, data)\n\t\t},\n\t},\n}\n</script>\n\n<style lang=\"scss\">\n@import './../../css/prosemirror';\n@import './../../css/print';\n</style>\n"],"names":["_sfc_main","ContentContainer","ReadonlyBar","MenuBar","MainContainer","Wrapper","val","EDITOR","ATTACHMENT_RESOLVER","IS_RICH_EDITOR","AttachmentResolver","getCurrentUser","content","markdownit","RichText","History","FocusTrap","Editor","editor","markdown","createMarkdownSerializer","visible","event","data"],"mappings":"m4BAqCA,MAAAA,EAAA,CACA,KAAA,wBACA,WAAA,CAAA,iBAAAC,EAAA,YAAAC,EAAA,QAAAC,EAAA,cAAAC,EAAA,QAAAC,CAAA,EACA,SAAA,CACA,MAAAC,EAAA,CAAA,EAEA,OAAA,OAAA,iBAAAA,EAAA,CACA,CAAAC,CAAA,EAAA,CACA,IAAA,IAAA,KAAA,OACA,EACA,CAAAC,CAAA,EAAA,CACA,IAAA,IAAA,KAAA,qBAAA,IACA,EACA,CAAAC,CAAA,EAAA,CACA,IAAA,IAAA,EACA,CACA,CAAA,EAEAH,CACA,EAEA,MAAA,CACA,OAAA,CACA,KAAA,OACA,QAAA,IACA,EACA,QAAA,CACA,KAAA,OACA,SAAA,EACA,EACA,SAAA,CACA,KAAA,QACA,QAAA,EACA,EACA,aAAA,CACA,KAAA,OACA,QAAA,EACA,EACA,WAAA,CACA,KAAA,OACA,QAAA,IACA,EACA,YAAA,CACA,KAAA,QACA,QAAA,EACA,EACA,mBAAA,CACA,KAAA,QACA,QAAA,EACA,CACA,EACA,MAAA,CAAA,gBAAA,EAEA,SAAA,CACA,aAAA,CACA,OAAA,KAAA,WAAA,KAAA,OAAA,CACA,CACA,EAEA,MAAA,CACA,SAAA,CACA,KAAA,cAAA,CACA,CACA,EAEA,SAAA,CACA,KAAA,QAAA,KAAA,aAAA,EACA,KAAA,QAAA,YAAA,CAAA,KAAA,QAAA,EACA,KAAA,SACA,KAAA,oBAAA,IAAAI,EAAA,CACA,iBAAA,KAAA,cAAA,MAAA,MAAA,EACA,KAAAC,EAAA,EACA,WAAA,KAAA,WACA,OAAA,KAAA,MACA,CAAA,EAEA,EAEA,SAAA,CACA,KAAA,QAAA,YAAA,CAAA,KAAA,QAAA,CACA,EAEA,eAAA,CACA,KAAA,QAAA,QAAA,CACA,EAEA,QAAA,CACA,WAAAC,EAAA,CACA,OAAAC,EAAA,OAAAD,CAAA,CACA,EACA,YAAA,CACA,MAAA,CACAE,EAAA,UAAA,CACA,UAAA,KACA,WAAA,CACAC,CACA,CACA,CAAA,EACAC,CACA,CACA,EACA,cAAA,CACA,OAAA,IAAAC,EAAA,CACA,QAAA,KAAA,YACA,WAAA,KAAA,WAAA,EACA,SAAA,CAAA,CAAA,OAAAC,KAAA,CACA,MAAAC,EAAAC,EAAA,KAAA,QAAA,MAAA,EAAA,UAAAF,EAAA,MAAA,GAAA,EACA,KAAA,KAAA,iBAAA,CACA,KAAAA,EAAA,MAAA,IACA,SAAAC,CACA,CAAA,CACA,EACA,SAAA,CAAA,CAAA,OAAAD,KAAA,CACA,KAAA,MAAA,OAAA,EACA,KAAA,QAAA,MAAA,OAAA,CACA,CACA,CAAA,CACA,EAEA,eAAA,CACA,KAAA,QAAA,SAAA,WAAA,KAAA,YAAA,EAAA,CACA,EAEA,eAAAG,EAAA,CACA,KAAA,KAAA,kBAAAA,CAAA,CACA,EAcA,KAAAC,EAAAC,EAAA,CACA,KAAA,MAAAD,EAAAC,CAAA,EACA,KAAA,SAAA,MAAAD,EAAAC,CAAA,CACA,CACA,CACA"}